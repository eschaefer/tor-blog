<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>How to handle millions of new Tor clients</title>
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://torblog.lan//how-to-handle-millions-new-tor-clients">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">The Tor Project Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
	<a class="page-link" href="/">Blog Home</a>
        <a class="page-link" href="/archive">Archives</a>
	<a class="page-link" href="https://www.torproject.org/about/overview">About Tor</a>
        <a class="page-link donate" href="https://www.torproject.org/donate/donate">Donate</a>

      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <!-- Pages with side column need a 'maincol' class -->
<div class="post maincol">

  <header class="post-header">
    <h1 class="post-title">How to handle millions of new Tor clients</h1>
    <p class="post-meta">Sep 5, 2013 • arma</p>
  </header>

  <article class="post-content">
    <p>[<strong>tl;dr</strong>: if you want your Tor to be more stable, upgrade to a Tor Browser Bundle with Tor 0.2.4.x in it, and then wait for enough relays to upgrade to today&#39;s 0.2.4.17-rc release.]</p>

<p>Starting around August 20, we started to see a sudden spike in the number of Tor clients. By now it&#39;s unmistakable: there are millions of new Tor clients and the numbers continue to rise:</p>

<p><img src="https://people.torproject.org/%7Earma/direct-users-2013-07-07-2013-09-04.png" alt="Tor users in summer 2013"></p>

<p>Where do these new users come from? My current best answer is a botnet.</p>

<p>Some people have speculated that the growth in users comes from activists in Syria, Russia, the United States, or some other country that has good reason to have activists and journalists adopting Tor en masse lately. Others have speculated that it&#39;s due to massive adoption of the Pirate Browser (a Tor Browser Bundle fork that discards most of Tor&#39;s security and privacy features), but we&#39;ve talked to the Pirate Browser people and the downloads they&#39;ve seen can&#39;t account for this growth. The fact is, with a growth curve like this one, there&#39;s basically no way that there&#39;s a new human behind each of these new Tor clients. These Tor clients got bundled into some new software which got installed onto millions of computers pretty much overnight. Since no large software or operating system vendors have come forward to tell us they just bundled Tor with all their users, that leaves me with one conclusion: somebody out there infected millions of computers and as part of their plan they installed Tor clients on them.</p>

<p>It doesn&#39;t look like the new clients are using the Tor network to send traffic to external destinations (like websites). Early indications are that they&#39;re accessing hidden services — fast relays see &quot;Received an ESTABLISH_RENDEZVOUS request&quot; many times a second in their info-level logs, but fast exit relays don&#39;t report a significant growth in exit traffic. One plausible explanation (assuming it is indeed a botnet) is that it&#39;s running its <a href="http://en.wikipedia.org/wiki/Botnet#Organization">Command and Control (C&amp;C)</a> point as a hidden service.</p>

<p>My first observation is &quot;holy cow, the network is still working.&quot; I guess all that work we&#39;ve been doing on scalability was a good idea. The second observation is that these new clients actually aren&#39;t adding that much traffic to the network. Most of the pain we&#39;re seeing is from all the new circuits they&#39;re making — Tor clients build circuits preemptively, and millions of Tor clients means millions of circuits. Each circuit requires the relays to do expensive public key operations, and many of our relays are now maxed out on CPU load.</p>

<p>There&#39;s a possible dangerous cycle here: when a client tries to build a circuit but it fails, it tries again. So if relays are so overwhelmed that they each drop half the requests they get, then more than half the attempted circuits will fail (since all the relays on the circuit have to succeed), generating even more circuit requests.</p>

<p>So, how do we survive in the face of millions of new clients?</p>

<p>Step one was to see if there was some simple way to distinguish them from other clients, like checking <a href="https://trac.torproject.org/projects/tor/ticket/9653">if they&#39;re using an old version of Tor</a>, and have entry nodes refuse connections from them. Alas, it looks like they&#39;re running 0.2.3.x, which is the current recommended stable.</p>

<p>Step two is to get more users using the <a href="https://gitweb.torproject.org/tor.git/blob/refs/tags/tor-0.2.4.17-rc:/ChangeLog#l769">NTor circuit-level handshake</a>, which is new in Tor 0.2.4 and offers stronger security with lower processing overhead (and thus less pain to relays). Tor 0.2.4.17-rc comes with an added twist: we <a href="https://trac.torproject.org/projects/tor/ticket/9574">prioritize</a> NTor create cells over the old <a href="http://freehaven.net/anonbib/date.html#tap:pet2006">TAP</a> create cells that 0.2.3 clients send, which a) means relays will get the cheap computations out of the way first so they&#39;re more likely to succeed, and b) means that Tor 0.2.4 users will jump the queue ahead of the botnet requests. The Tor 0.2.4.17-rc release also comes with some new log messages to <a href="https://trac.torproject.org/projects/tor/ticket/9658">help relay operators track how many of each handshake type they&#39;re handling</a>.</p>

<p>(There&#39;s some tricky calculus to be done here around whether the botnet operator will upgrade his bots in response. Nobody knows for sure. But hopefully not for a while, and in any case the new handshake is a lot cheaper so it would still be a win.)</p>

<p>Step three is to temporarily disable some of the client-side performance features that build extra circuits. In particular, our <a href="https://gitweb.torproject.org/tor.git/blob/tor-0.2.4.17-rc:/ReleaseNotes#l1764">circuit build timeout</a> feature estimates network performance for each user individually, so we can tune which circuits we use and which we discard. First, in a world where successful circuits are rare, discarding some — even the slow ones — might be unwise. Second, to arrive at a good estimate faster, clients make a series of throwaway measurement circuits. And if the network is ever flaky enough, clients discard that estimate and go back and measure it again. These are all fine approaches in a network where most relays can handle traffic well; but they can contribute to the above vicious cycle in an overloaded network. The next step is to <a href="https://trac.torproject.org/projects/tor/ticket/9670">slow down these exploratory circuits</a> in order to reduce the load on the network. (We would temporarily disable the circuit build timeout feature entirely, but it turns out we had a <a href="https://trac.torproject.org/projects/tor/ticket/9671">bug where things get worse in that case</a>.)</p>

<p>Step four is longer-term: there remain some <a href="https://trac.torproject.org/projects/tor/ticket/9662">NTor handshake performance improvements</a> that will make them faster still. It would be nice to get circuit handshakes on the relay side to be really cheap; but it&#39;s an open research question how close we can get to that goal while still providing strong handshake security.</p>

<p>Of course, the above steps aim only to get our head back above water for this particular incident. For the future we&#39;ll need to explore further options. For example, we could rate-limit circuit create requests at entry guards. Or we could learn to recognize the circuit building signature of a bot client (maybe it triggers a new hidden service rendezvous every n minutes) and refuse or <a href="http://en.wikipedia.org/wiki/Tarpit_%28networking%29">tarpit</a> connections from them. Maybe entry guards should demand that clients solve captchas before they can build more than a threshold of circuits. Maybe we rate limit TAP handshakes at the relays, so we leave more CPU available for other crypto operations like TLS and AES. Or maybe we should immediately refuse all TAP cells, effectively shutting 0.2.3 clients out of the network.</p>

<p>In parallel, it would be great if botnet researchers would identify the particular characteristics of the botnet and start looking at ways to shut it down (or at least get it off of Tor). Note that getting rid of the C&amp;C point may not really help, since it&#39;s the rendezvous attempts from the bots that are hurting so much.</p>

<p>And finally, I still maintain that if you have a multi-million node botnet, it&#39;s silly to try to hide it behind the 4000-relay Tor network. These people should be using their botnet as a peer-to-peer anonymity system for itself. So I interpret this incident as continued exploration by botnet developers to try to figure out what resources, services, and topologies integrate well for protecting botnet communications. Another facet of solving this problem long-term is helping them to understand that Tor isn&#39;t a great answer for their problem.</p>

  </article>

  <div class="post-footer">
      <a class="post-blog" href="">arma's Blog</a>
  </div>
  <br />

<!-- COMMENTS -->

<!--  <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jmttest'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->

<div id="comments" class="comments clearfix">
  <div class="comments-loading">
  <p><em>Enable Javascript to view comments</em></p>
  </div>
</div>

<script type="text/javascript" class="juvia">
(function() {
    var loadingSection = document.body.querySelector('.comments-loading');
    var icon = '<p>Comments Loading...</p><img alt="loading comments" src="/assets/images/comments-loading.gif">';

    loadingSection.innerHTML = loadingSection.innerHTML + icon;

    var options = {
        container    : '.comments',
//        site_key     : 'im3x57usjcg72fkm6lyqzwzt7vaoi4g',
        site_key     : '44vvejwwbxje75ke0zv308dpvsf8pvl',
        topic_key    : '/how-to-handle-millions-new-tor-clients',
        topic_url    : location.href,
        topic_title  : document.title || location.href,
        include_base : !window.Juvia,
        include_css  : !window.Juvia,
        comment_order: 'latest-first'
    };

    function makeQueryString(options) {
        var key, params = [];
        for (key in options) {
            params.push(
                encodeURIComponent(key) +
                '=' +
                encodeURIComponent(options[key]));
        }
        return params.join('&');
    }

    function makeApiUrl(options) {
        // Makes sure that each call generates a unique URL, otherwise
        // the browser may not actually perform the request.
        if (!('_juviaRequestCounter' in window)) {
            window._juviaRequestCounter = 0;
        }

        var result =
//            'http://torblog-juvia-4525.herokuapp.com/api/show_topic.js' +
            'http://juvia.torblog.lan/api/show_topic.js' +
	    '?_c=' + window._juviaRequestCounter +
            '&' + makeQueryString(options);
        window._juviaRequestCounter++;
        return result;
    }

    var s       = document.createElement('script');
    s.async     = true;
    s.type      = 'text/javascript';
    s.className = 'juvia';
    s.src       = makeApiUrl(options);

    (document.getElementsByTagName('head')[0] ||
      document.getElementsByTagName('body')[0] && commentsLoaded).appendChild(s);

})();
</script>
</div>

<!-- Include the side column -->
<div class="sidecol">

<!-- RSS FEED / SEARCH -->
    <div class="sidefirst">
	<a href="/feed.xml"><img src="/assets/images/rss.png" alt="RSS logo">RSS</a>
	<!-- <a href="#"><img src="/img/rss.png">Atom</a> -->
	<form>
        <input class="searchtext" type="text" size="10" maxlength="10"><input class="searchbutton" type="submit" value="Search">
        </form>
    </div>

<!-- EVENTS -->
    <div class ="sidebox orangebox">
	<h2>Upcoming Events</h2>
	<ul>
	    
		    <li><span><a href="/tor-winter-dev-meeting-2015">Tor Winter Dev Meeting 2015</a></span></li>
	    
		    <li><span><a href="/roger-and-jake-rightscon-manila">Roger and Jake at RightsCon in Manila</a></span></li>
	    
		    <li><span><a href="/tor-booth-fosdem-2015">Tor booth at FOSDEM 2015</a></span></li>
	    
		    <li><span><a href="/many-tor-people-pets-philadelphia">Many Tor people at PETS in Philadelphia</a></span></li>
	    
	</ul>
	<span><a href="/events">full calendar &raquo;</a></span>
    </div>
    
<!-- RECENT BLOG POSTS -->
    <div class ="sidebox greenbox">
	<h2>Recent Blog Posts</h2>
	<ul>
	  
		    <li><span><a href="/tor-weekly-news--february-11th-2015">Tor Weekly News — February 11th, 2015</a></span></li>
	  
		    <li><span><a href="/ux-sprint-2015-wrapup">UX Sprint 2015 wrapup</a></span></li>
	  
		    <li><span><a href="/guest-post-library-freedom-project-bringing-privacy-and-anonymity-libraries">Guest Post: The Library Freedom Project: Bringing privacy and anonymity to libraries</a></span></li>
	  
		    <li><span><a href="/tor-design-proposals-how-we-make-changes-our-protocol">Tor design proposals: how we make changes to our protocol</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news--february-4th-2015">Tor Weekly News — February 4th, 2015</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news--january-28th-2015">Tor Weekly News — January 28th, 2015</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news--january-21st-2015">Tor Weekly News — January 21st, 2015</a></span></li>
	  
		    <li><span><a href="/tor-browser-45a3-released">Tor Browser 4.5a3 is released</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news--january-14th-2015">Tor Weekly News — January 14th, 2015</a></span></li>
	  
		    <li><span><a href="/tor-browser-403-released">Tor Browser 4.0.3 is released</a></span></li>
	  
	</ul>
	<span><a href="/archive">more &raquo;</a></span>
    </div>
    
<!-- TAG CLOUD -->
    <div class ="tagbox orangebox">
	<h2>Blog Tag Cloud</h2>
	<ul>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/blog/">
            blog
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/first post/">
            first post
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 171%">
        <span><a href="/tag/tor/">
            tor
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/24c3/">
            24c3
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/ccc/">
            ccc
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 61%">
        <span><a href="/tag/talks/">
            talks
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 59%">
        <span><a href="/tag/bugs/">
            bugs
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/crashes/">
            crashes
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 64%">
        <span><a href="/tag/osx/">
            osx
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/qt/">
            qt
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 84%">
        <span><a href="/tag/vidalia/">
            vidalia
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 67%">
        <span><a href="/tag/vidalia bundle/">
            vidalia bundle
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/meetup/">
            meetup
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 61%">
        <span><a href="/tag/attacks/">
            attacks
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/covert channels/">
            covert channels
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/media coverage/">
            media coverage
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 88%">
        <span><a href="/tag/bridges/">
            bridges
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 59%">
        <span><a href="/tag/incognito/">
            incognito
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 113%">
        <span><a href="/tag/progress report/">
            progress report
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 84%">
        <span><a href="/tag/torbrowser/">
            torbrowser
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 83%">
        <span><a href="/tag/torbutton/">
            torbutton
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 65%">
        <span><a href="/tag/china/">
            china
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/directors/">
            directors
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 75%">
        <span><a href="/tag/release candidate/">
            release candidate
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 74%">
        <span><a href="/tag/gsoc/">
            gsoc
        </a></span>
    </li>

	</ul>
	<span><a href="/tag-cloud">more tags &raquo;</a></span>
    </div>

</div>

<div style="clear: both;"></div>  

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The Tor Project Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>The Tor Project Blog</li>
          <li><a href="mailto:contact@torproject.org">contact@torproject.org</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jekyll">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">jekyll</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/jekyllrb">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">jekyllrb</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

  </div>

</footer>


 <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jmttest'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    
  </body>

</html>
