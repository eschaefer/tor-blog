<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Top changes in Tor since the 2004 design paper (Part 3)</title>
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="/blog/top-changes-tor-2004-design-paper-part-3">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">The Tor Project Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
	<a class="page-link" href="/">Blog Home</a>
        <a class="page-link" href="/archive">Archives</a>
	<a class="page-link" href="https://www.torproject.org/about/overview">About Tor</a>
        <a class="page-link donate" href="https://www.torproject.org/donate/donate">Donate</a>

      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <!-- Pages with side column need a 'maincol' class -->
<div class="post maincol">

  <header class="post-header">
    <h1 class="post-title">Top changes in Tor since the 2004 design paper (Part 3)</h1>
    <p class="post-meta">Nov 1, 2012 • sjmurdoch</p>
  </header>

  <article class="post-content">
    <p>In this third and final installment of Nick Mathewson and Steven Murdoch&#39;s blog series (previously <a href="https://blog.torproject.org/blog/top-changes-tor-2004-design-paper-part-1">part 1</a> and <a href="https://blog.torproject.org/blog/top-changes-tor-2004-design-paper-part-2">part 2</a>) we discuss how Tor has made its traffic harder to fingerprint, as well as usability and security improvements to how users interact with Tor.</p>

<h2>9. Link protocol TLS, renegotiation</h2>

<p>Tor&#39;s original (version 1) TLS handshake was fairly straightforward. The client said that it supported a sensible set of cryptographic algorithms and parameters (ciphersuites, in TLS terminology) and the server selected one. If one side wanted to prove to the other that it was a Tor node, it would send a two-element certificate chain signed by the key published in the Tor directory.</p>

<p>This approach met all the security properties envisaged at the time the 2004 design paper was written, but Tor&#39;s increasing use in censorship resistance changed the requirements – Tor&#39;s protocol signature also had to look like that of HTTPS web traffic, to prevent censors using deep-packet-inspection to detect and block Tor.</p>

<p>It turned out that Tor&#39;s original design looked very different from HTTPS. Firstly, web browsers offer a wide range of ciphersuites which Tor cannot use, such as those using RC4 (due to the narrow security margins) and RSA key exchange (due to lack of <a href="https://en.wikipedia.org/wiki/Perfect_forward_secrecy">forward secrecy</a>). Secondly, in HTTPS web traffic, the client seldom offers a certificate, and the server usually offers a one-element certificate chain, whereas in Tor node-to-node communication both sides offer a two-element certificate chain.</p>

<p>Therefore <a href="https://gitweb.torproject.org/torspec.git/blob/HEAD:/proposals/124-tls-certificates.txt">proposal 124</a>, later superseded by <a href="https://gitweb.torproject.org/torspec.git/blob/HEAD:/proposals/130-v2-conn-protocol.txt">proposal 130</a>, tried to resolve the situation and the resulting version 2 connection protocol was implemented in Tor 0.2.0.20-rc. Here, the client presents a large selection of ciphersuites (including some it doesn&#39;t actually support), selected to appear similar to that of a web browser. The server then chooses one which is suitable for use in Tor, but if the server chooses one which is not adequately secure, the client will pull down the connection.</p>

<p>To make the certificate part of the handshake look closer to HTTPS, the client sends no certificate, and the server sends a one-element dummy certificate chain. The certificate offered by the server is designed to not contain distinctive strings which could be used for blocking (version 1 certificates used &quot;Tor&quot; or &quot;TOR&quot; as the organization name). Once the handshake is complete, Tor then restarts the handshake (via TLS renegotiation), but now encrypted under the keys established in the first handshake, and sends the two-element certificate chains as before.</p>

<p>This improves the situation for anti-blocking considerably, although more could still be done. In particular, the fact that renegotiation is occurring is not hidden from an observer because the type of TLS messages (known as records) is not encrypted in TLS, and renegotiation records are of a different type from data records. Therefore version 3 of the connection protocol, described in <a href="https://gitweb.torproject.org/torspec.git/blob/HEAD:/proposals/176-revising-handshake.txt">proposal 176</a> and implemented in Tor 0.2.3.6-alpha, moves the second stage of the handshake into data records, binding the inner to the outer handshake through sharing some key material.</p>

<h2>10. Rise and fall of .exit</h2>

<p>In Tor 0.0.9rc5, Tor had the .exit feature added. Here, if the user requested <em>domain</em>.<em>nickname</em>.exit then Tor would make a connection to <em>domain</em> using the Tor node called <em>nickname</em> as the last hop (if possible). This was a convenient feature for exploring how the Internet looked from different locations, but it also raised some security concerns.</p>

<p>In particular, a malicious website could embed an image with a .exit hostname, forcing the Tor client to select an attacker-controlled exit node. Then, if the user also chooses an attacker-controlled entry node the circuit could be de-anonymized. This strategy increases the probability of a successful attack from about (M/N)<sup>2</sup> to M/N (where M is the amount of attacker-controlled network resource and N is the total network resource).</p>

<p>Therefore, in Tor 0.2.2.1-alpha, .exit notation was disabled by default. In Tor 0.2.3.17-beta an exception was made, allowing .exit notation when it is specified in the configuration file or by a controller. These sources are assumed to be safe, and by combining the .exit notation with the MapAddress option it is possible for the client to always contact some domain names via a particular exit node. This is useful when a service is running on the same machine as a Tor node, as then the user can choose for circuits to never leave the Tor network.</p>

<h2>11. Controller protocol</h2>

<p>Tor has always had a minimalist user interface – it can be configured on the command line or a configuration file and sends output to a log file. This is fine for advanced users, but most users will prefer a GUI. Building a GUI into Tor would be difficult, and would force certain choices (e.g. GUI toolkit) to be made which might not suit all users and all platforms. Therefore the approach taken by Tor in 0.0.9pre5 is to build an interface for other programs – the control protocol – to communicate with the Tor daemon, extracting information to display on the GUI and changing the Tor configuration based on user actions.</p>

<p>The control protocol has also proven useful to researchers experimenting with Tor. Initially the functionality exposed in the control protocol was simply that exposed by the configuration file and log files. Providing status information in a specified and machine-readable format made the task of monitoring and controlling Tor easier. Later, functionality was added to the control protocol which should not be exposed to ordinary Tor users but is useful to researchers, such as allowing controllers to arbitrarily control the path selection process (added in 0.1.0.1-rc).</p>

<p>In 0.1.1.1-alpha the protocol was changed to version 1, which used ASCII rather than binary commands to make it easier to write and debug controllers as well as allow advanced users to telnet into the control port and manually type commands.</p>

<h2>12. Torbutton</h2>

<p>The 2004 design paper stated that Tor explicitly did not make any attempt to scrub application data which might contain identifying information. By adopting the near universal SOCKS protocol, almost any application could send its traffic over Tor, but there was no guarantee it would be safe to do so. This is in contrast to the the predecessors to Tor from the Onion Routing project which required an &quot;application proxy&quot; to be written for each protocol carried by Tor. These proxies greatly increased the cost for supporting each additional application.</p>

<p>Still, there was clear need for a place to perform the protocol scrubbing, and so Tor recommended that <a href="http://www.privoxy.org/">Privoxy</a> take the place of an application proxy for HTTP. However, the disadvantages of this approach gradually became clear, in particular Privoxy could not inspect or modify HTTPS traffic and so malicious websites could send their tracking code over HTTPS and avoid scrubbing.</p>

<p>Therefore, more and more of the scrubbing was performed by a Firefox add-on, <a href="https://www.torproject.org/torbutton/">Torbutton</a>, which also could turn Tor on and off – hence the name. Torbutton had full access to content regardless of whether it was HTTP or HTTPS and could also disable features of Firefox which were bad for privacy. A proxy was still needed though, because Firefox&#39;s SOCKS support handled high-latency connections badly, so the lighter-weight <a href="http://www.pps.univ-paris-diderot.fr/%7Ejch/software/polipo/">Polipo</a> was adopted instead.</p>

<h2>13. Tor Browser Bundle</h2>

<p>Now to use Tor, most users would need to download and install Tor, Firefox, Torbutton and Polipo, probably along with a GUI controller such as <a href="https://www.torproject.org/projects/vidalia.html.en">Vidalia</a>. This was inconvenient, especially for customers of Internet cafes who could not install software on the computer they were using. So the Tor Browser Bundle was created which included all this software, pre-configured to be run from a USB drive.</p>

<p>This was far easier to use than the previous way to install Tor, and eventually became the default. It had the added advantage that we could modify the browser to include patches which made Polipo unnecessary and to fix some privacy problems which could not be solved from within a Firefox add-on. It was also safer for users because now Torbutton could not be disabled, meaning that the user had different web browsers for anonymous and non-anonymous browsing and were less likely to muddle up the two.</p>

  </article>

  <div class="post-footer">
      <a class="post-blog" href="">sjmurdoch's Blog</a>
  </div>
  <br />

<!-- COMMENTS -->
<div id="comments" class="comments clearfix">
  <div class="comments-loading">
  <p><em>Enable Javascript to view comments</em></p>
  </div>
</div>

<script type="text/javascript" class="juvia">
(function() {
    var loadingSection = document.body.querySelector('.comments-loading');
    var icon = '<p>Comments Loading...</p><img alt="loading comments" src="/assets/images/comments-loading.gif">';

    loadingSection.innerHTML = loadingSection.innerHTML + icon;

    var options = {
        container    : '.comments',
        site_key     : 'im3x57usjcg72fkm6lyqzwzt7vaoi4g',
        topic_key    : '/blog/top-changes-tor-2004-design-paper-part-3',
        topic_url    : location.href,
        topic_title  : document.title || location.href,
        include_base : !window.Juvia,
        include_css  : !window.Juvia,
        comment_order: 'latest-first'
    };

    function makeQueryString(options) {
        var key, params = [];
        for (key in options) {
            params.push(
                encodeURIComponent(key) +
                '=' +
                encodeURIComponent(options[key]));
        }
        return params.join('&');
    }

    function makeApiUrl(options) {
        // Makes sure that each call generates a unique URL, otherwise
        // the browser may not actually perform the request.
        if (!('_juviaRequestCounter' in window)) {
            window._juviaRequestCounter = 0;
        }

        var result =
            'http://torblog-juvia-4525.herokuapp.com/api/show_topic.js' +
            '?_c=' + window._juviaRequestCounter +
            '&' + makeQueryString(options);
        window._juviaRequestCounter++;
        return result;
    }

    var s       = document.createElement('script');
    s.async     = true;
    s.type      = 'text/javascript';
    s.className = 'juvia';
    s.src       = makeApiUrl(options);

    (document.getElementsByTagName('head')[0] ||
      document.getElementsByTagName('body')[0] && commentsLoaded).appendChild(s);

})();
</script>
</div>

<!-- Include the side column -->
<div class="sidecol">

<!-- RSS FEED / SEARCH -->
    <div class="sidefirst">
	<a href="/feed.xml"><img src="/assets/images/rss.png" alt="RSS logo">RSS</a>
	<!-- <a href="#"><img src="/img/rss.png">Atom</a> -->
	<form>
        <input class="searchtext" type="text" size="10" maxlength="10"><input class="searchbutton" type="submit" value="Search">
        </form>
    </div>

<!-- EVENTS -->
    <div class ="sidebox orangebox">
	<h2>Upcoming Events</h2>
	<ul>
	    
		    <li><span><a href="/events/andrew-keynotes-broadband-world-forum">Andrew Keynotes Broadband World Forum</a></span></li>
	    
		    <li><span><a href="/events/roger-usenix-security-symposium-san-diego-ca">Roger @ Usenix Security Symposium, San Diego, CA</a></span></li>
	    
		    <li><span><a href="/events/roger-foci-%E2%80%9914-san-diego-ca">Roger @ FOCI ’14, San Diego, CA</a></span></li>
	    
		    <li><span><a href="/events/tor-pets-2014-amsterdam">Tor @ PETS 2014, Amsterdam</a></span></li>
	    
	</ul>
	<span><a href="/events">full calendar &raquo;</a></span>
    </div>
    
<!-- RECENT BLOG POSTS -->
    <div class ="sidebox greenbox">
	<h2>Recent Blog Posts</h2>
	<ul>
	  
		    <li><span><a href="/tor-weekly-news-%E2%80%94-october-8th-2014">Tor Weekly News — October 8th, 2014</a></span></li>
	  
		    <li><span><a href="/closer-look-great-firewall-china">A closer look at the Great Firewall of China</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news-%E2%80%94-october-1st-2014">Tor Weekly News — October 1st, 2014</a></span></li>
	  
		    <li><span><a href="/tor-browser-40-alpha-3-released">Tor Browser 4.0-alpha-3 is released</a></span></li>
	  
		    <li><span><a href="/tor-browser-366-released">Tor Browser 3.6.6 is released</a></span></li>
	  
		    <li><span><a href="/tails-112-out">Tails 1.1.2 is out</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news-%E2%80%94-september-24th-2014">Tor Weekly News — September 24th, 2014</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news-%E2%80%94-september-17th-2014">Tor Weekly News — September 17th, 2014</a></span></li>
	  
		    <li><span><a href="/tor-0257-rc-out">Tor 0.2.5.7-rc is out</a></span></li>
	  
		    <li><span><a href="/tor-weekly-news-%E2%80%94-september-10th-2014">Tor Weekly News — September 10th, 2014</a></span></li>
	  
	</ul>
	<span><a href="/archive">more &raquo;</a></span>
    </div>
    
<!-- TAG CLOUD -->
    <div class ="tagbox orangebox">
	<h2>Blog Tag Cloud</h2>
	<ul>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/blog/">
            blog
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/first post/">
            first post
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 171%">
        <span><a href="/tag/tor/">
            tor
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/24c3/">
            24c3
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/ccc/">
            ccc
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 61%">
        <span><a href="/tag/talks/">
            talks
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 59%">
        <span><a href="/tag/bugs/">
            bugs
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/crashes/">
            crashes
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 64%">
        <span><a href="/tag/osx/">
            osx
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/qt/">
            qt
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 86%">
        <span><a href="/tag/vidalia/">
            vidalia
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 68%">
        <span><a href="/tag/vidalia bundle/">
            vidalia bundle
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/meetup/">
            meetup
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 59%">
        <span><a href="/tag/attacks/">
            attacks
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/covert channels/">
            covert channels
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 57%">
        <span><a href="/tag/media coverage/">
            media coverage
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 88%">
        <span><a href="/tag/bridges/">
            bridges
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 59%">
        <span><a href="/tag/incognito/">
            incognito
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 116%">
        <span><a href="/tag/progress report/">
            progress report
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 83%">
        <span><a href="/tag/torbrowser/">
            torbrowser
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 85%">
        <span><a href="/tag/torbutton/">
            torbutton
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 65%">
        <span><a href="/tag/china/">
            china
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 56%">
        <span><a href="/tag/directors/">
            directors
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 76%">
        <span><a href="/tag/release candidate/">
            release candidate
        </a></span>
    </li>

    <!-- this is wack - be careful adjusting these values -->
    <li style="font-size: 74%">
        <span><a href="/tag/gsoc/">
            gsoc
        </a></span>
    </li>

	</ul>
	<span><a href="/tag-cloud">more tags &raquo;</a></span>
    </div>

</div>

<div style="clear: both;"></div>  

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The Tor Project Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>The Tor Project Blog</li>
          <li><a href="mailto:contact@torproject.org">contact@torproject.org</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jekyll">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">jekyll</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/jekyllrb">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">jekyllrb</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
